<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - Track Your Spending</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Track your spending, discover patterns - works offline!">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Expenses">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <link rel="apple-touch-icon" href="icons/icon-192.svg">

    <!-- Styles - Local files for offline support -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="lib/flatpickr.min.css">

    <!-- Scripts - Local files for offline support -->
    <script src="lib/chart.min.js"></script>
    <script src="lib/flatpickr.min.js"></script>
</head>

<body>
    <div class="container">
        <!-- Online Status Indicator -->
        <div id="onlineStatus" class="online-status online">
            <span class="status-dot"></span> Online
        </div>

        <header>
            <h1>üí∞ Expense Tracker</h1>
            <p class="subtitle">Track your spending, discover patterns</p>
        </header>

        <!-- Summary Cards -->
        <section class="summary-cards">
            <div class="card summary-card">
                <div class="card-icon">üìä</div>
                <div class="card-content">
                    <h3>This Month</h3>
                    <p class="amount" id="thisMonthTotal">‚Çπ0.00</p>
                    <span class="change" id="monthlyChange">-</span>
                </div>
            </div>
            <div class="card summary-card">
                <div class="card-icon">üìà</div>
                <div class="card-content">
                    <h3>Total Expenses</h3>
                    <p class="amount" id="totalExpenses">‚Çπ0.00</p>
                </div>
            </div>
            <div class="card summary-card">
                <div class="card-icon">üßæ</div>
                <div class="card-content">
                    <h3>Transactions</h3>
                    <p class="amount" id="totalTransactions">0</p>
                </div>
            </div>
        </section>

        <!-- Main Content - 3 Column Layout -->
        <div class="main-content">
            <!-- Left Panel - Add Expense Form -->
            <div class="left-panel">
                <!-- Add Expense Form -->
                <section class="card">
                    <h2>‚ûï Add Expense</h2>
                    <form id="expenseForm">
                        <div class="form-group">
                            <label for="description">Description (Optional)</label>
                            <input type="text" id="description" placeholder="What did you spend on?">
                        </div>
                        <div class="form-group">
                            <label for="amount">Amount (‚Çπ)</label>
                            <input type="number" id="amount" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <input type="hidden" id="category" required>
                            <div id="categoryOptions" class="category-options"></div>
                        </div>
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="text" id="date" required style="display: none;">
                            <div id="dateCalendar" class="inline-calendar"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Expense</button>
                    </form>
                </section>

                <!-- Collapsible Category Management -->
                <div class="collapsible-section">
                    <button class="collapsible-toggle" onclick="toggleCategorySection()">
                        <span>‚öôÔ∏è Manage Categories</span>
                        <span class="toggle-icon">‚ñº</span>
                    </button>

                    <div class="collapsible-content" id="categorySection">
                        <!-- Add Category Form -->
                        <div class="collapsible-card">
                            <h3>üè∑Ô∏è Add New Category</h3>
                            <form id="categoryForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="categoryName">Name</label>
                                        <input type="text" id="categoryName" placeholder="e.g., Groceries" required>
                                    </div>
                                    <div class="form-group form-group-small">
                                        <label for="categoryIcon">Icon</label>
                                        <input type="text" id="categoryIcon" placeholder="üõí" maxlength="2">
                                    </div>
                                    <div class="form-group form-group-small">
                                        <label for="categoryColor">Color</label>
                                        <input type="color" id="categoryColor" value="#0D9488">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-secondary btn-compact">+ Add Category</button>
                            </form>
                        </div>

                        <!-- Categories List -->
                        <div class="collapsible-card">
                            <h3>üìÇ Your Categories</h3>
                            <div id="categoriesList" class="categories-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center Panel - Charts & Patterns -->
            <div class="center-panel">
                <!-- Charts -->
                <section class="card charts-section">
                    <h2>üìä Spending Overview</h2>
                    <div class="charts-container">
                        <div class="chart-wrapper">
                            <h3>By Category</h3>
                            <canvas id="categoryChart"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <h3>Monthly Trends</h3>
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Patterns -->
                <section class="card">
                    <h2>üîç Spending Patterns</h2>
                    <div id="patternsList" class="patterns-list"></div>
                </section>

                <!-- Collapsible Insights Section -->
                <div class="collapsible-section collapsible-section-large">
                    <button class="collapsible-toggle" onclick="toggleInsightsSection()">
                        <span>üí° Insights & Analytics</span>
                        <span class="toggle-icon">‚ñº</span>
                    </button>

                    <div class="collapsible-content" id="insightsSection">
                        <!-- Quick Stats Row -->
                        <div class="insights-grid">
                            <div class="insight-card">
                                <div class="insight-icon">üìÖ</div>
                                <div class="insight-content">
                                    <span class="insight-label">Daily Average</span>
                                    <span class="insight-value" id="dailyAverage">‚Çπ0.00</span>
                                </div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-icon">üìÜ</div>
                                <div class="insight-content">
                                    <span class="insight-label">Weekly Average</span>
                                    <span class="insight-value" id="weeklyAverage">‚Çπ0.00</span>
                                </div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-icon">üéØ</div>
                                <div class="insight-content">
                                    <span class="insight-label">Predicted Monthly</span>
                                    <span class="insight-value" id="predictedMonthly">‚Çπ0.00</span>
                                </div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-icon">üî•</div>
                                <div class="insight-content">
                                    <span class="insight-label">Peak Spending Day</span>
                                    <span class="insight-value" id="peakDay">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Spending Alerts -->
                        <div class="insight-block">
                            <h3>‚ö†Ô∏è Spending Alerts</h3>
                            <div id="spendingAlerts" class="alerts-list">
                                <div class="alert-item alert-neutral">No unusual spending detected</div>
                            </div>
                        </div>

                        <!-- Budget Tracking -->
                        <div class="insight-block">
                            <h3>üí∞ Budget Tracking <button class="btn-link" onclick="openBudgetModal()">Set
                                    Budgets</button></h3>
                            <div id="budgetTracking" class="budget-list">
                                <p class="text-muted">No budgets set. Click "Set Budgets" to get started.</p>
                            </div>
                        </div>

                        <!-- Top Expenses This Month -->
                        <div class="insight-block">
                            <h3>üèÜ Top Expenses This Month</h3>
                            <div id="topExpenses" class="top-expenses-list"></div>
                        </div>

                        <!-- Category Comparison -->
                        <div class="insight-block">
                            <h3>üìä vs Last Month</h3>
                            <div id="categoryComparison" class="comparison-list"></div>
                        </div>

                        <!-- Spending Streaks -->
                        <div class="insight-block streaks-block">
                            <div class="streak-item">
                                <span class="streak-icon">üåü</span>
                                <div class="streak-content">
                                    <span class="streak-value" id="noSpendStreak">0 days</span>
                                    <span class="streak-label">No-Spend Streak</span>
                                </div>
                            </div>
                            <div class="streak-item">
                                <span class="streak-icon">üìà</span>
                                <div class="streak-content">
                                    <span class="streak-value" id="spendingStreak">0 days</span>
                                    <span class="streak-label">Spending Streak</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Recent Expenses -->
            <div class="right-panel">
                <!-- Recent Expenses -->
                <section class="card">
                    <div class="expenses-header">
                        <h2>üìù Recent Expenses</h2>
                        <button class="btn btn-small btn-outline" onclick="openAllTransactionsModal()">View All</button>
                    </div>
                    <div class="expenses-controls">
                        <select id="sortBy" class="sort-select">
                            <option value="date">Sort by Date</option>
                            <option value="amount">Sort by Amount</option>
                            <option value="category">Sort by Category</option>
                        </select>
                        <select id="sortOrder" class="sort-select">
                            <option value="desc">Descending</option>
                            <option value="asc">Ascending</option>
                        </select>
                    </div>
                    <div id="expensesList" class="expenses-list"></div>
                </section>
            </div>
        </div>
    </div>

    <!-- Budget Modal -->
    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBudgetModal()">&times;</span>
            <h2>üí∞ Set Monthly Budgets</h2>
            <p class="modal-subtitle">Set spending limits for each category</p>
            <div id="budgetForm" class="budget-form"></div>
            <button class="btn btn-primary" onclick="saveBudgets()">Save Budgets</button>
        </div>
    </div>

    <!-- All Transactions Modal -->
    <div id="allTransactionsModal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" onclick="closeAllTransactionsModal()">&times;</span>
            <h2>üìã All Transactions</h2>
            <div class="modal-controls">
                <div class="search-box">
                    <input type="text" id="searchTransactions" placeholder="Search transactions..."
                        oninput="filterTransactions()">
                </div>
                <div class="filter-controls">
                    <select id="filterCategory" class="sort-select" onchange="filterTransactions()">
                        <option value="">All Categories</option>
                    </select>
                    <select id="filterMonth" class="sort-select" onchange="filterTransactions()">
                        <option value="">All Time</option>
                    </select>
                </div>
            </div>
            <div class="transactions-summary">
                <span id="transactionCount">0 transactions</span>
                <span id="transactionTotal">Total: ‚Çπ0.00</span>
            </div>
            <div id="allExpensesList" class="expenses-list expenses-list-full"></div>
        </div>
    </div>

    <!-- Edit Expense Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Edit Expense</h2>
            <form id="editExpenseForm">
                <input type="hidden" id="editExpenseId">
                <div class="form-group">
                    <label for="editDescription">Description (Optional)</label>
                    <input type="text" id="editDescription">
                </div>
                <div class="form-group">
                    <label for="editAmount">Amount (‚Çπ)</label>
                    <input type="number" id="editAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <input type="hidden" id="editCategory" required>
                    <div id="editCategoryOptions" class="category-options"></div>
                </div>
                <div class="form-group">
                    <label for="editDate">Date</label>
                    <input type="text" id="editDate" required style="display: none;">
                    <div id="editDateCalendar" class="inline-calendar"></div>
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Offline Support Scripts -->
    <script src="offline-db.js"></script>
    <script src="sync.js"></script>
    <script src="app.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('Service Worker registered:', registration.scope);

                    // Handle updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available
                                if (confirm('New version available! Reload to update?')) {
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                    window.location.reload();
                                }
                            }
                        });
                    });
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                }
            });
        }
    </script>
</body>

</html>